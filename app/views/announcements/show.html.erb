<% content_for :page_title, @announcement.title %>

<!-- Status Banner -->
<% if @announcement.status == 'delivered' %>
  <div class="alert alert-success" style="margin-bottom: 24px;">
    âœ“ This announcement was successfully delivered
    <% if @announcement.delivery_date %>
      on <%= @announcement.delivery_date.strftime("%B %d, %Y at %I:%M %p") %>
    <% end %>
  </div>
<% elsif @announcement.status == 'pending' %>
  <div class="alert alert-warning" style="margin-bottom: 24px;">
    â³ This announcement is scheduled for delivery
    <% if @announcement.delivery_date %>
      on <%= @announcement.delivery_date.strftime("%B %d, %Y at %I:%M %p") %>
    <% end %>
  </div>
<% elsif @announcement.status == 'failed' %>
  <div class="alert alert-danger" style="margin-bottom: 24px;">
    âœ• This announcement failed to deliver. Please review and try again.
  </div>
<% end %>

<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px; flex-wrap: wrap;">
    <div style="flex: 1;">
      <h2 class="page-header__title"><%= @announcement.title %></h2>
      <div style="display: flex; gap: 12px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
        <% if @announcement.status == 'delivered' %>
          <span class="badge badge-success">âœ“ Delivered</span>
        <% elsif @announcement.status == 'pending' %>
          <span class="badge badge-warning">â³ Pending</span>
        <% elsif @announcement.status == 'failed' %>
          <span class="badge badge-danger">âœ• Failed</span>
        <% else %>
          <span class="badge badge-info"><%= @announcement.status&.titleize || "Draft" %></span>
        <% end %>
        
        <span style="color: var(--text-secondary); font-size: 13px;">
          Created <%= @announcement.created_at.strftime("%b %d, %Y") %>
        </span>
      </div>
    </div>
    <div style="display: flex; gap: 12px;">
      <%= link_to "Edit", edit_announcement_path(@announcement), class: "btn btn-secondary" %>
      <%= button_to "Delete", announcement_path(@announcement), 
          method: :delete, 
          data: { confirm: "Are you sure? This cannot be undone." },
          class: "btn btn-danger" %>
    </div>
  </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
  <!-- Main Content -->
  <div>
    <!-- Message Content -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card__header">
        <h3 class="card__title">Message</h3>
      </div>
      <div style="line-height: 1.6; white-space: pre-wrap;">
        <% 
          message_text = if @announcement.respond_to?(:message) && @announcement.message.present?
            @announcement.message
          elsif @announcement.respond_to?(:body) && @announcement.body.present?
            @announcement.body
          elsif @announcement.respond_to?(:content) && @announcement.content.present?
            @announcement.content
          elsif @announcement.respond_to?(:description) && @announcement.description.present?
            @announcement.description
          elsif @announcement.respond_to?(:text) && @announcement.text.present?
            @announcement.text
          else
            "No message content"
          end
        %>
        <%= message_text %>
      </div>
    </div>
    
    <!-- Delivery Schedule -->
    <% if @announcement.delivery_date %>
      <div class="card">
        <div class="card__header">
          <h3 class="card__title">ğŸ“… Scheduled Delivery</h3>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="background: rgba(30, 174, 219, 0.1); padding: 16px; border-radius: 8px; text-align: center; min-width: 100px;">
            <div style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">
              <%= @announcement.delivery_date.strftime("%d") %>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase;">
              <%= @announcement.delivery_date.strftime("%b %Y") %>
            </div>
          </div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">
              <%= @announcement.delivery_date.strftime("%A, %B %d, %Y") %>
            </div>
            <div style="color: var(--text-secondary); font-size: 14px;">
              at <%= @announcement.delivery_date.strftime("%I:%M %p") %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Sidebar -->
  <div>
    <!-- Details Card -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="card__header">
        <h3 class="card__title">Details</h3>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 20px;">
        <div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
            Audience
          </div>
          <div style="font-weight: 600; color: var(--text-primary);">
            <% 
              audience = if @announcement.respond_to?(:audience) && @announcement.audience.present?
                @announcement.audience
              elsif @announcement.respond_to?(:audience_id) && @announcement.audience_id.present?
                begin
                  Audience.find(@announcement.audience_id)
                rescue
                  nil
                end
              else
                nil
              end
            %>
            <% if audience %>
              <%= link_to audience.name, audience_path(audience), 
                  style: "color: var(--primary-blue); text-decoration: none;" %>
            <% else %>
              <span style="color: var(--text-muted);">No audience</span>
            <% end %>
          </div>
          <% if audience && audience.respond_to?(:recipients) %>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
              <%= audience.recipients.count %> recipients
            </div>
          <% end %>
        </div>
        
        <div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
            Delivery Channel
          </div>
          <div style="font-weight: 600;">
            <% if @announcement.respond_to?(:message_type) && @announcement.message_type.present? %>
              <% if @announcement.message_type == 'email' %>
                ğŸ“§ Email
              <% elsif @announcement.message_type == 'slack' %>
                ğŸ’¬ Slack
              <% elsif @announcement.message_type == 'both' %>
                ğŸ“§ğŸ’¬ Email & Slack
              <% else %>
                <%= @announcement.message_type.titleize %>
              <% end %>
            <% elsif @announcement.respond_to?(:channel) && @announcement.channel.present? %>
              <% if @announcement.channel == 'email' %>
                ğŸ“§ Email
              <% elsif @announcement.channel == 'slack' %>
                ğŸ’¬ Slack
              <% elsif @announcement.channel == 'whatsapp' %>
                ğŸ“± WhatsApp
              <% else %>
                <%= @announcement.channel.titleize %>
              <% end %>
            <% else %>
              <span style="color: var(--text-muted);">Not specified</span>
            <% end %>
          </div>
        </div>
        
        <div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
            Status
          </div>
          <div>
            <% if @announcement.status == 'delivered' %>
              <span class="badge badge-success">âœ“ Delivered</span>
            <% elsif @announcement.status == 'pending' %>
              <span class="badge badge-warning">â³ Pending</span>
            <% elsif @announcement.status == 'failed' %>
              <span class="badge badge-danger">âœ• Failed</span>
            <% else %>
              <span class="badge badge-info"><%= @announcement.status&.titleize || "Draft" %></span>
            <% end %>
          </div>
        </div>
        
        <div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
            Created
          </div>
          <div style="font-weight: 500;">
            <%= @announcement.created_at.strftime("%B %d, %Y at %I:%M %p") %>
          </div>
        </div>
        
        <% if @announcement.updated_at != @announcement.created_at %>
          <div>
            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
              Last Updated
            </div>
            <div style="font-weight: 500;">
              <%= @announcement.updated_at.strftime("%B %d, %Y at %I:%M %p") %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Actions Card -->
    <div class="card">
      <div class="card__header">
        <h3 class="card__title">Actions</h3>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <%= link_to edit_announcement_path(@announcement), 
            class: "btn btn-secondary", 
            style: "width: 100%; justify-content: center;" do %>
          <span>âœï¸ Edit Announcement</span>
        <% end %>
        
        <% if @announcement.status == 'draft' || @announcement.status == 'failed' %>
          <%= button_to "Send Now", announcement_path(@announcement, announcement: { status: 'pending' }), 
              method: :patch,
              data: { confirm: "Send this announcement now?" },
              class: "btn btn-primary",
              style: "width: 100%; justify-content: center;" %>
        <% end %>
        
        <%= link_to announcements_path, 
            class: "btn btn-secondary", 
            style: "width: 100%; justify-content: center;" do %>
          <span>â† Back to Announcements</span>
        <% end %>
      </div>
    </div>
  </div>
</div>
