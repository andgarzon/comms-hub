<% content_for :page_title, @announcement.new_record? ? "New Announcement" : "Edit Announcement" %>

<div class="page-header">
  <h2 class="page-header__title"><%= @announcement.new_record? ? "Create Announcement" : "Edit Announcement" %></h2>
  <p class="page-header__description">
    <%= @announcement.new_record? ? "Fill in the details to create your announcement" : "Update your announcement details" %>
  </p>
</div>

<div style="max-width: 900px;">
  <%= form_with(model: @announcement, local: true) do |form| %>
    <% if @announcement.errors.any? %>
      <div class="alert alert-danger" style="margin-bottom: 24px;">
        <strong style="font-size: 15px; display: block; margin-bottom: 8px;">
          <%= pluralize(@announcement.errors.count, "error") %> prevented this announcement from being saved:
        </strong>
        <ul style="margin: 8px 0 0 20px;">
          <% @announcement.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="card" style="margin-bottom: 20px;">
      <div class="card__header">
        <h3 class="card__title">Basic Information</h3>
      </div>

      <div class="form-group">
        <%= form.label :title, class: "form-label" %>
        <%= form.text_field :title, class: "form-control", placeholder: "e.g., Team Meeting Tomorrow at 3 PM" %>
      </div>

      <div class="form-group" style="margin-bottom: 0; position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <%= form.label :base_body, "Message Content", class: "form-label", style: "margin: 0;" %>
          <button type="submit" name="improve_with_ai" value="1" id="ai-improve-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">
            âœ¨ AI Improve
          </button>
        </div>
        <%= form.text_area :base_body, rows: 8, class: "form-control", id: "message-textarea", placeholder: "Enter your announcement message..." %>
        <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
          This message will be sent to all recipients in the selected audiences
        </small>

        <!-- AI Loading State -->
        <div id="ai-loading" style="display: none; margin-top: 12px; padding: 12px; background: #E6F7FF; border-radius: 6px; border-left: 3px solid var(--primary-blue);">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--primary-blue); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="font-size: 13px; color: var(--primary-blue);">AI is improving your message...</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
      <div class="card__header">
        <h3 class="card__title">Delivery Settings</h3>
      </div>

      <!-- Multi-Select Audiences -->
      <div class="form-group">
        <%= form.label :audience_ids, "Target Audiences", class: "form-label" %>
        <div style="border: 1px solid var(--border-medium); border-radius: var(--radius-sm); padding: 12px; background: white; max-height: 200px; overflow-y: auto;">
          <% if Audience.any? %>
            <% Audience.all.each do |audience| %>
              <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                     onmouseover="this.style.background='var(--bg-hover)'"
                     onmouseout="this.style.background='transparent'">
                <%
                  is_selected = if @announcement.respond_to?(:audience_ids) && @announcement.audience_ids.present?
                    @announcement.audience_ids.include?(audience.id)
                  else
                    false
                  end
                %>
                <%= check_box_tag 'announcement[audience_ids][]', audience.id, is_selected,
                    id: "audience_#{audience.id}",
                    style: "margin-right: 8px;" %>
                <div style="flex: 1;">
                  <div style="font-weight: 500;"><%= audience.name %></div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    <%= audience.recipients_count %> recipients
                  </div>
                </div>
              </label>
            <% end %>
          <% else %>
            <div style="text-align: center; padding: 16px; color: var(--text-secondary); font-size: 13px;">
              No audiences available. <%= link_to "Create one", new_audience_path, style: "color: var(--primary-blue);" %>
            </div>
          <% end %>
        </div>
        <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
          Select one or more audiences to receive this announcement
        </small>
      </div>

      <!-- Multi-Select Channels (Checkboxes) -->
      <div class="form-group">
        <%= label_tag :delivery_channels, "Delivery Channels", class: "form-label" %>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px;">
          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_email, class: "channel-checkbox", id: "channel_email" %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ“§</div>
              <div class="channel-name">Email</div>
              <div class="channel-desc">Send via email</div>
            </div>
          </label>

          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_slack, class: "channel-checkbox", id: "channel_slack" %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ’¬</div>
              <div class="channel-name">Slack</div>
              <div class="channel-desc">Send to Slack</div>
            </div>
          </label>

          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_whatsapp, class: "channel-checkbox", id: "channel_whatsapp" %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ“±</div>
              <div class="channel-name">WhatsApp</div>
              <div class="channel-desc">Send via WhatsApp</div>
            </div>
          </label>
        </div>
        <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
          Select one or more channels for delivery
        </small>
      </div>

      <div class="form-group" style="margin-bottom: 0;">
        <%= form.label :scheduled_for, "Schedule Delivery", class: "form-label" %>
        <%= form.datetime_local_field :scheduled_for, class: "form-control" %>
        <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
          Leave empty to send immediately
        </small>
      </div>
    </div>

    <% unless @announcement.new_record? %>
      <div class="card" style="margin-bottom: 20px;">
        <div class="card__header">
          <h3 class="card__title">Status</h3>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <%= form.label :status, class: "form-label" %>
          <%= form.select :status,
              [['Draft', 'draft'], ['Scheduled', 'scheduled'], ['Sending', 'sending'], ['Sent', 'sent'], ['Failed', 'failed']],
              {},
              { class: "form-control" } %>
        </div>
      </div>
    <% end %>

    <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center;">
      <div>
        <% unless @announcement.new_record? %>
          <%= button_to "Delete Announcement", announcement_path(@announcement),
              method: :delete,
              data: { confirm: "Are you sure? This cannot be undone." },
              class: "btn btn-danger" %>
        <% end %>
      </div>
      <div style="display: flex; gap: 12px;">
        <%= link_to "Cancel", @announcement.new_record? ? announcements_path : announcement_path(@announcement), class: "btn btn-secondary" %>
        <%= form.submit @announcement.new_record? ? "Create Announcement" : "Save Changes", class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
</div>

<style>
  /* Channel checkboxes styling */
  .channel-option-checkbox {
    position: relative;
    cursor: pointer;
    border: 2px solid var(--border-medium);
    border-radius: var(--radius-md);
    padding: 16px;
    transition: all 0.2s;
    background: white;
    display: block;
  }

  .channel-option-checkbox:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-sm);
  }

  .channel-option-checkbox:has(.channel-checkbox:checked) {
    border-color: var(--primary-blue);
    background: rgba(30, 174, 219, 0.05);
  }

  .channel-checkbox {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .channel-content {
    text-align: center;
    margin-top: 8px;
  }

  .channel-icon {
    font-size: 28px;
    margin-bottom: 8px;
  }

  .channel-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
    font-size: 14px;
  }

  .channel-desc {
    font-size: 12px;
    color: var(--text-secondary);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
