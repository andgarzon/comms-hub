<% content_for :page_title, @announcement.new_record? ? "New Announcement" : "Edit Announcement" %>

<%
  # Load improved announcement if provided
  if params[:improved_id].present?
    improved = Announcement.find(params[:improved_id])
    @announcement = Announcement.new(improved.attributes.except('id', 'created_at', 'updated_at', 'user_id', 'status'))
  end
%>

<div class="page-header">
  <h2 class="page-header__title"><%= @announcement.new_record? ? "Create Announcement" : "Edit Announcement" %></h2>
  <p class="page-header__description">
    <%= @announcement.new_record? ? "Fill in the details to create your announcement" : "Update your announcement details" %>
  </p>
</div>

<div class="max-w-900">
  <%= form_with(model: @announcement, url: announcements_path, method: :post, data: { turbo: false }, html: { id: "announcement-form" }) do |form| %>
    <% if @announcement.errors.any? %>
      <div class="alert alert-danger error-list">
        <strong class="error-list__title">
          <%= pluralize(@announcement.errors.count, "error") %> prevented this announcement from being saved:
        </strong>
        <ul class="error-list__items">
          <% @announcement.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Basic Information Card -->
    <div class="card mb-20">
      <div class="card__header">
        <h3 class="card__title">Basic Information</h3>
      </div>

      <div class="form-group">
        <%= form.label :title, class: "form-label" %>
        <%= form.text_field :title, class: "form-control", placeholder: "e.g., Team Meeting Tomorrow at 3 PM" %>
      </div>

      <div class="form-group mb-0">
        <div class="base-message-header">
          <%= form.label :base_body, "Base Message", class: "form-label form-label--inline" %>
          <div data-react-component="AiImproveButton"
               data-react-props='<%= { mode: "submit", submitName: "improve_with_ai", formId: "announcement-form", csrfToken: form_authenticity_token }.to_json %>'></div>
        </div>
        <%= form.text_area :base_body, rows: 8, class: "form-control", id: "message-textarea", placeholder: "Write your core message here. AI can adapt it for each channel..." %>
        <small class="form-hint">
          This is your master copy. Click "AI Improve" to generate channel-specific versions.
        </small>
      </div>
    </div>

    <!-- Channel-Specific Messages Card -->
    <div class="card mb-20">
      <div class="card__header">
        <h3 class="card__title">Channel-Specific Messages</h3>
      </div>
      <small class="form-hint mb-16 block">
        These fields are auto-filled when you use AI Improve, or you can customize each version manually.
      </small>

      <div class="form-group">
        <%= form.label :email_body, "ðŸ“§ Email Version", class: "form-label" %>
        <%= form.text_area :email_body, rows: 6, class: "form-control", placeholder: "Detailed email message with full context..." %>
        <small class="form-hint">Email allows for longer, more detailed content</small>
      </div>

      <div class="form-group">
        <%= form.label :slack_body, "ðŸ’¬ Slack Version", class: "form-label" %>
        <%= form.text_area :slack_body, rows: 4, class: "form-control", placeholder: "Concise Slack message..." %>
        <small class="form-hint">Keep it brief â€” 2-3 sentences work best for Slack</small>
      </div>

      <div class="form-group mb-0">
        <%= form.label :whatsapp_body, "ðŸ“± WhatsApp Version", class: "form-label" %>
        <%= form.text_area :whatsapp_body, rows: 3, class: "form-control", placeholder: "Short WhatsApp message..." %>
        <small class="form-hint">Ultra-concise â€” 1-2 sentences ideal for WhatsApp</small>
      </div>
    </div>

    <!-- Delivery Settings Card -->
    <div class="card mb-20">
      <div class="card__header">
        <h3 class="card__title">Delivery Settings</h3>
      </div>

      <!-- Delivery Channels -->
      <div class="form-group">
        <%= label_tag :delivery_channels, "Delivery Channels", class: "form-label" %>
        <div class="grid-3-col">
          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_email, class: "channel-checkbox", id: "channel_email", data: { channel: "email" } %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ“§</div>
              <div class="channel-name">Email</div>
              <div class="channel-desc">Send via email</div>
            </div>
          </label>

          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_slack, class: "channel-checkbox", id: "channel_slack", data: { channel: "slack" } %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ’¬</div>
              <div class="channel-name">Slack</div>
              <div class="channel-desc">Send to Slack</div>
            </div>
          </label>

          <label class="channel-option-checkbox">
            <%= form.check_box :send_to_whatsapp, class: "channel-checkbox", id: "channel_whatsapp", data: { channel: "whatsapp" } %>
            <div class="channel-content">
              <div class="channel-icon">ðŸ“±</div>
              <div class="channel-name">WhatsApp</div>
              <div class="channel-desc">Send via WhatsApp</div>
            </div>
          </label>
        </div>
        <small class="form-hint">Select one or more channels, then choose audiences below</small>
      </div>

      <!-- React component for channel/audience toggling -->
      <div data-react-component="ChannelAudienceToggler"
           data-react-props='<%= { channels: [
             { name: "email", sectionId: "email-audiences-section" },
             { name: "slack", sectionId: "slack-audiences-section" },
             { name: "whatsapp", sectionId: "whatsapp-audiences-section" }
           ] }.to_json %>'></div>

      <!-- Audiences per Channel -->
      <div id="email-audiences-section" class="channel-audience-section hidden">
        <div class="form-group">
          <label class="form-label">ðŸ“§ Email Audiences</label>
          <div class="audience-list audience-list--lg">
            <% if @email_audiences.present? %>
              <% @email_audiences.each do |audience| %>
                <label class="audience-list__item">
                  <%= check_box_tag 'announcement[audience_ids][]', audience.id,
                      @announcement.audience_ids.include?(audience.id),
                      id: "audience_#{audience.id}", class: "audience-list__item-checkbox" %>
                  <div class="audience-list__item-info">
                    <div class="audience-list__item-name"><%= audience.name %></div>
                    <div class="audience-list__item-meta"><%= audience.recipients_count %> recipients</div>
                  </div>
                </label>
              <% end %>
            <% else %>
              <div class="audience-list__empty">
                No email audiences yet. <%= link_to "Create one", new_email_audience_path, class: "text-blue" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div id="slack-audiences-section" class="channel-audience-section hidden">
        <div class="form-group">
          <label class="form-label">ðŸ’¬ Slack Audiences</label>
          <div class="audience-list audience-list--lg">
            <% if @slack_audiences.present? %>
              <% @slack_audiences.each do |audience| %>
                <label class="audience-list__item">
                  <%= check_box_tag 'announcement[audience_ids][]', audience.id,
                      @announcement.audience_ids.include?(audience.id),
                      id: "audience_#{audience.id}", class: "audience-list__item-checkbox" %>
                  <div class="audience-list__item-info">
                    <div class="audience-list__item-name"><%= audience.name %></div>
                    <div class="audience-list__item-meta">#<%= audience.slack_channel %></div>
                  </div>
                </label>
              <% end %>
            <% else %>
              <div class="audience-list__empty">
                No Slack audiences yet. <%= link_to "Create one", new_slack_audience_path, class: "text-blue" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div id="whatsapp-audiences-section" class="channel-audience-section hidden">
        <div class="form-group">
          <label class="form-label">ðŸ“± WhatsApp Audiences</label>
          <div class="audience-list audience-list--lg">
            <% if @whatsapp_audiences.present? %>
              <% @whatsapp_audiences.each do |audience| %>
                <label class="audience-list__item">
                  <%= check_box_tag 'announcement[audience_ids][]', audience.id,
                      @announcement.audience_ids.include?(audience.id),
                      id: "audience_#{audience.id}", class: "audience-list__item-checkbox" %>
                  <div class="audience-list__item-info">
                    <div class="audience-list__item-name"><%= audience.name %></div>
                    <div class="audience-list__item-meta"><%= audience.recipients_count %> contacts</div>
                  </div>
                </label>
              <% end %>
            <% else %>
              <div class="audience-list__empty">
                No WhatsApp audiences yet. <%= link_to "Create one", new_whatsapp_audience_path, class: "text-blue" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Schedule -->
      <div class="form-group mb-0">
        <%= form.label :scheduled_for, "Schedule Delivery", class: "form-label" %>
        <%= form.datetime_local_field :scheduled_for, class: "form-control" %>
        <small class="form-hint">Leave empty to send immediately</small>
      </div>
    </div>

    <!-- Submit -->
    <div class="form-actions">
      <%= link_to "Cancel", announcements_path, class: "btn btn-secondary" %>
      <%= form.submit "Create Announcement", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<!-- AI Loading Overlay (React component) -->
<div data-react-component="AiLoadingOverlay"></div>
