<% content_for :page_title, "Announcements" %>
<%# ULTRA-SAFE VERSION - All attributes checked with respond_to? - v3.0 %>

<div class="page-header">
  <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
    <div style="flex: 1;">
      <h2 class="page-header__title">Announcements</h2>
      <p class="page-header__description">Manage and send communications to your audiences</p>
    </div>
    <div>
      <%= link_to new_announcement_path, class: "btn btn-primary" do %>
        <span style="font-size: 18px; margin-right: 4px;">+</span>
        <span>Create Announcement</span>
      <% end %>
    </div>
  </div>
</div>

<!-- Filters Card -->
<div class="card" style="margin-bottom: 24px;">
  <%= form_with url: announcements_path, method: :get, local: true do |f| %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
      <div class="form-group" style="margin: 0;">
        <%= label_tag :status, "Status", class: "form-label" %>
        <%= select_tag :status, 
            options_for_select([
              ['All Statuses', ''],
              ['Draft', 'draft'],
              ['Pending', 'pending'],
              ['Delivered', 'delivered'],
              ['Failed', 'failed']
            ], params[:status]), 
            class: "form-control" %>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <%= label_tag :audience_id, "Audience", class: "form-label" %>
        <%= select_tag :audience_id,
            options_from_collection_for_select(Audience.all, :id, :name, params[:audience_id]),
            { include_blank: 'All Audiences', class: "form-control" } %>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <%= label_tag :search, "Search", class: "form-label" %>
        <%= text_field_tag :search, params[:search], 
            placeholder: "Search announcements...", 
            class: "form-control" %>
      </div>
      
      <div style="display: flex; gap: 8px;">
        <%= submit_tag "Filter", class: "btn btn-primary" %>
        <%= link_to "Clear", announcements_path, class: "btn btn-secondary" %>
      </div>
    </div>
  <% end %>
</div>

<!-- Announcements Table -->
<div class="card">
  <% if @announcements.any? %>
    <table class="table">
      <thead>
        <tr>
          <th>Title & Message</th>
          <th>Audience</th>
          <th>Channel</th>
          <th>Status</th>
          <th>Delivery Date</th>
          <th style="text-align: right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @announcements.each do |announcement| %>
          <tr onclick="window.location='<%= announcement_path(announcement) %>'" style="cursor: pointer;">
            <td>
              <div style="font-weight: 600; margin-bottom: 4px;"><%= announcement.title %></div>
              <div style="font-size: 13px; color: var(--text-secondary);">
                <% 
                  message_text = if announcement.respond_to?(:message) && announcement.message.present?
                    announcement.message
                  elsif announcement.respond_to?(:body) && announcement.body.present?
                    announcement.body
                  elsif announcement.respond_to?(:content) && announcement.content.present?
                    announcement.content
                  elsif announcement.respond_to?(:description) && announcement.description.present?
                    announcement.description
                  elsif announcement.respond_to?(:text) && announcement.text.present?
                    announcement.text
                  else
                    "No message"
                  end
                %>
                <%= truncate(message_text, length: 60) %>
              </div>
            </td>
            <td>
              <% 
                audience_name = if announcement.respond_to?(:audience) && announcement.audience.present?
                  announcement.audience.name
                elsif announcement.respond_to?(:audience_id) && announcement.audience_id.present?
                  begin
                    Audience.find(announcement.audience_id).name
                  rescue
                    "N/A"
                  end
                else
                  "N/A"
                end
              %>
              <%= audience_name %>
            </td>
            <td>
              <% if announcement.respond_to?(:message_type) && announcement.message_type.present? %>
                <% if announcement.message_type == 'email' %>
                  <span style="font-size: 18px;" title="Email">ğŸ“§</span>
                <% elsif announcement.message_type == 'slack' %>
                  <span style="font-size: 18px;" title="Slack">ğŸ’¬</span>
                <% elsif announcement.message_type == 'both' %>
                  <span style="font-size: 18px;" title="Email & Slack">ğŸ“§ğŸ’¬</span>
                <% else %>
                  <span style="color: var(--text-muted);">â€”</span>
                <% end %>
              <% elsif announcement.respond_to?(:channel) && announcement.channel.present? %>
                <% if announcement.channel == 'email' %>
                  <span style="font-size: 18px;" title="Email">ğŸ“§</span>
                <% elsif announcement.channel == 'slack' %>
                  <span style="font-size: 18px;" title="Slack">ğŸ’¬</span>
                <% elsif announcement.channel == 'whatsapp' %>
                  <span style="font-size: 18px;" title="WhatsApp">ğŸ“±</span>
                <% else %>
                  <span style="color: var(--text-muted);">â€”</span>
                <% end %>
              <% else %>
                <span style="color: var(--text-muted);">â€”</span>
              <% end %>
            </td>
            <td>
              <% if announcement.status == 'delivered' %>
                <span class="badge badge-success">âœ“ Delivered</span>
              <% elsif announcement.status == 'pending' %>
                <span class="badge badge-warning">â³ Pending</span>
              <% elsif announcement.status == 'failed' %>
                <span class="badge badge-danger">âœ• Failed</span>
              <% else %>
                <span class="badge badge-info"><%= announcement.status&.titleize || "Draft" %></span>
              <% end %>
            </td>
            <td>
              <% 
                delivery = if announcement.respond_to?(:delivery_date) && announcement.delivery_date.present?
                  announcement.delivery_date
                elsif announcement.respond_to?(:scheduled_at) && announcement.scheduled_at.present?
                  announcement.scheduled_at
                elsif announcement.respond_to?(:send_at) && announcement.send_at.present?
                  announcement.send_at
                elsif announcement.respond_to?(:scheduled_for) && announcement.scheduled_for.present?
                  announcement.scheduled_for
                else
                  nil
                end
              %>
              <% if delivery %>
                <%= delivery.strftime("%b %d, %Y at %I:%M %p") %>
              <% else %>
                <span style="color: var(--text-muted);">Not scheduled</span>
              <% end %>
            </td>
            <td style="text-align: right;" onclick="event.stopPropagation();">
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <%= link_to "Edit", edit_announcement_path(announcement), class: "btn btn-secondary", style: "padding: 6px 12px; font-size: 13px;" %>
                <%= button_to "Delete", announcement_path(announcement), 
                    method: :delete, 
                    data: { confirm: "Are you sure you want to delete this announcement?" },
                    class: "btn btn-danger",
                    style: "padding: 6px 12px; font-size: 13px;" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <!-- Pagination -->
    <% if @announcements.respond_to?(:total_pages) && @announcements.total_pages > 1 %>
      <div style="padding: 16px; border-top: 1px solid var(--border-light); display: flex; justify-content: center;">
        <%= paginate @announcements %>
      </div>
    <% end %>
  <% else %>
    <!-- Empty State -->
    <div style="text-align: center; padding: 64px 24px;">
      <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“¢</div>
      <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
        No announcements yet
      </h3>
      <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">
        <% if params[:status].present? || params[:audience_id].present? || params[:search].present? %>
          No announcements match your filters. Try adjusting your search criteria.
        <% else %>
          Get started by creating your first announcement to communicate with your audiences.
        <% end %>
      </p>
      <% unless params[:status].present? || params[:audience_id].present? || params[:search].present? %>
        <%= link_to new_announcement_path, class: "btn btn-primary" do %>
          <span style="font-size: 18px; margin-right: 4px;">+</span>
          <span>Create Your First Announcement</span>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
