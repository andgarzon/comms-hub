<% content_for :page_title, @audience.name %>

<%
  recipients_collection = if @audience.respond_to?(:recipients)
    recipients_collection
  elsif @audience.respond_to?(:users)
    @audience.users
  elsif @audience.respond_to?(:members)
    @audience.members
  else
    []
  end
%>

<div class="page-header page-header--row">
  <div class="flex-1">
    <div class="flex-row gap-12 mb-8">
      <h2 class="page-header__title"><%= @audience.name %></h2>
      <% case @audience.type %>
      <% when 'SlackAudience' %>
        <span class="badge badge-info">ğŸ’¬ Slack</span>
      <% when 'EmailAudience' %>
        <span class="badge badge-success">ğŸ“§ Email</span>
      <% when 'WhatsappAudience' %>
        <span class="badge badge-success">ğŸ“± WhatsApp</span>
      <% else %>
        <span class="badge badge-secondary">ğŸ‘¥ General</span>
      <% end %>
    </div>
    <% if @audience.description.present? %>
      <p class="page-header__description"><%= @audience.description %></p>
    <% end %>
  </div>
  <% if @audience.editable_by?(current_user) %>
    <div class="flex-row gap-12">
      <%= link_to "Edit", edit_audience_path(@audience), class: "btn btn-secondary" %>
      <%= button_to "Delete", audience_path(@audience), method: :delete,
          data: { confirm: "Are you sure? This will affect all associated announcements." },
          class: "btn btn-danger" %>
    </div>
  <% end %>
</div>

<div class="audience-show-grid">
  <!-- Main Content -->
  <div>
    <div class="card">
      <div class="card__header">
        <h3 class="card__title">Recipients</h3>
      </div>

      <% if recipients_collection.any? %>
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Department</th>
              <th>Added</th>
            </tr>
          </thead>
          <tbody>
            <% recipients_collection.limit(20).each do |recipient| %>
              <tr>
                <td class="font-medium"><%= recipient.name || recipient.email.split('@').first.titleize %></td>
                <td><%= recipient.email %></td>
                <td><%= recipient.department || "â€”" %></td>
                <td><%= recipient.created_at.strftime("%b %d, %Y") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <% if recipients_collection.count > 20 %>
          <div class="text-center p-16 border-top text-secondary text-sm">
            Showing first 20 of <%= recipients_collection.count %> recipients
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-state__icon">ğŸ‘¥</div>
          <p class="text-secondary mb-16">No recipients yet</p>
          <% if @audience.editable_by?(current_user) %>
            <%= link_to "Add Recipients", edit_audience_path(@audience), class: "btn btn-primary" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <% if @audience.type == 'SlackAudience' && @audience.slack_channel.present? %>
      <div class="card">
        <div class="card__header">
          <h3 class="card__title">Slack Channel</h3>
        </div>
        <p class="p-8"><%= @audience.slack_channel %></p>
      </div>
    <% end %>

    <% if @audience.type == 'EmailAudience' && @audience.email_recipients.present? %>
      <div class="card">
        <div class="card__header">
          <h3 class="card__title">Email Recipients</h3>
        </div>
        <p class="p-8 text-sm"><%= @audience.email_list.join(", ") %></p>
      </div>
    <% end %>

    <% if @audience.type == 'WhatsappAudience' && @audience.whatsapp_recipients.present? %>
      <div class="card">
        <div class="card__header">
          <h3 class="card__title">WhatsApp Recipients</h3>
        </div>
        <p class="p-8 text-sm"><%= @audience.whatsapp_list.join(", ") %></p>
      </div>
    <% end %>

    <div class="card">
      <div class="card__header">
        <h3 class="card__title">Announcements Sent</h3>
      </div>

      <% if @audience.announcements.any? %>
        <table class="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Status</th>
              <th>Sent Date</th>
            </tr>
          </thead>
          <tbody>
            <% @audience.announcements.order(created_at: :desc).limit(10).each do |announcement| %>
              <tr class="cursor-pointer" onclick="window.location='<%= announcement_path(announcement) %>'">
                <td class="font-medium"><%= announcement.title %></td>
                <td>
                  <% if announcement.status == 'delivered' %>
                    <span class="badge badge-success">Delivered</span>
                  <% elsif announcement.status == 'pending' %>
                    <span class="badge badge-warning">Pending</span>
                  <% elsif announcement.status == 'failed' %>
                    <span class="badge badge-danger">Failed</span>
                  <% else %>
                    <span class="badge badge-info"><%= announcement.status&.titleize || "Draft" %></span>
                  <% end %>
                </td>
                <td><%= announcement.delivery_date ? announcement.delivery_date.strftime("%b %d, %Y") : "Not scheduled" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="empty-state">
          <div class="empty-state__icon">ğŸ“¢</div>
          <p class="text-secondary text-sm">No announcements sent to this audience yet</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Sidebar -->
  <div>
    <div class="card mb-20">
      <div class="card__header">
        <h3 class="card__title">Statistics</h3>
      </div>

      <div class="flex-col gap-20">
        <div class="audience-stat-box audience-stat-box--blue">
          <div class="audience-stat-box__value audience-stat-box__value--blue"><%= recipients_collection.count %></div>
          <div class="audience-stat-box__label">Total Recipients</div>
        </div>

        <div class="audience-stat-box audience-stat-box--green">
          <div class="audience-stat-box__value audience-stat-box__value--green"><%= @audience.announcements.count %></div>
          <div class="audience-stat-box__label">Announcements Sent</div>
        </div>
      </div>
    </div>

    <div class="card mb-20">
      <div class="card__header">
        <h3 class="card__title">Details</h3>
      </div>

      <div class="flex-col gap-16">
        <div>
          <div class="detail-label">Channel</div>
          <div class="detail-value">
            <% case @audience.type %>
            <% when 'SlackAudience' %>
              ğŸ’¬ Slack
            <% when 'EmailAudience' %>
              ğŸ“§ Email
            <% when 'WhatsappAudience' %>
              ğŸ“± WhatsApp
            <% else %>
              ğŸ‘¥ General
            <% end %>
          </div>
        </div>

        <div>
          <div class="detail-label">Scope</div>
          <div class="detail-value">
            <% case @audience.scope_type %>
            <% when "personal" %>
              <span class="badge badge-warning badge--sm">ğŸ”’ Personal</span>
            <% when "role" %>
              <span class="badge badge-info badge--sm">ğŸ‘¥ <%= @audience.scope_value&.upcase %> Role</span>
            <% when "system" %>
              <span class="badge badge-success badge--sm">ğŸŒ System-wide</span>
            <% else %>
              <span class="text-muted">Not set</span>
            <% end %>
          </div>
        </div>

        <% if @audience.creator.present? %>
          <div>
            <div class="detail-label">Created By</div>
            <div class="detail-value"><%= @audience.creator.email %></div>
          </div>
        <% end %>

        <div>
          <div class="detail-label">Created</div>
          <div class="detail-value"><%= @audience.created_at.strftime("%B %d, %Y") %></div>
        </div>

        <% if @audience.updated_at != @audience.created_at %>
          <div>
            <div class="detail-label">Last Updated</div>
            <div class="detail-value"><%= @audience.updated_at.strftime("%B %d, %Y") %></div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="card">
      <div class="card__header">
        <h3 class="card__title">Actions</h3>
      </div>

      <div class="flex-col gap-8">
        <% if @audience.editable_by?(current_user) %>
          <%= link_to edit_audience_path(@audience), class: "btn btn-secondary btn--full" do %>
            âœï¸ Edit Audience
          <% end %>
        <% end %>

        <%= link_to new_announcement_path(audience_id: @audience.id), class: "btn btn-primary btn--full" do %>
          ğŸ“¢ Create Announcement
        <% end %>

        <%= link_to audiences_path, class: "btn btn-secondary btn--full" do %>
          â† Back to Audiences
        <% end %>
      </div>
    </div>
  </div>
</div>
