<% content_for :page_title, "Audiences" %>

<div class="page-header page-header--row">
  <div>
    <h2 class="page-header__title">Audiences</h2>
    <p class="page-header__description">Manage your recipient groups and distribution lists</p>
  </div>
  <div>
    <%= link_to "Create New Audience", new_audience_path, class: "btn btn-primary" %>
  </div>
</div>

<% if @audiences.any? %>
  <div class="grid-auto-fill-300">
    <% @audiences.each do |audience| %>
      <div class="card audience-card" onclick="window.location='<%= audience_path(audience) %>'">
        <div class="audience-card__bar"></div>
        <div class="audience-card__body">
          <!-- Audience Type Badge -->
          <div class="mb-16">
            <% if audience.type == 'DynamicAudience' %>
              <span class="badge badge-info badge--sm">ðŸ”„ Dynamic</span>
            <% else %>
              <span class="badge badge-success badge--sm">ðŸ“‹ Static</span>
            <% end %>
          </div>

          <h3 class="audience-card__name"><%= audience.name %></h3>

          <% if audience.description.present? %>
            <p class="audience-card__desc"><%= truncate(audience.description, length: 100) %></p>
          <% else %>
            <p class="audience-card__desc audience-card__desc--empty">No description provided</p>
          <% end %>

          <!-- Stats -->
          <div class="audience-card__stats">
            <div class="audience-card__stat">
              <div class="audience-card__stat-value">
                <%
                  recipient_count = if audience.respond_to?(:recipients) && audience.recipients.respond_to?(:count)
                    audience.recipients.count
                  elsif audience.respond_to?(:users) && audience.users.respond_to?(:count)
                    audience.users.count
                  elsif audience.respond_to?(:members) && audience.members.respond_to?(:count)
                    audience.members.count
                  elsif audience.respond_to?(:recipient_count)
                    audience.recipient_count
                  else
                    0
                  end
                %>
                <%= recipient_count %>
              </div>
              <div class="audience-card__stat-label">Recipients</div>
            </div>

            <div class="audience-card__stat">
              <div class="audience-card__stat-value audience-card__stat-value--green">
                <%= audience.announcements.count %>
              </div>
              <div class="audience-card__stat-label">Announcements</div>
            </div>
          </div>

          <% if audience.type == 'DynamicAudience' && audience.query.present? %>
            <div class="audience-card__query">
              <div class="audience-card__query-label">Query</div>
              <div class="audience-card__query-value"><%= truncate(audience.query, length: 50) %></div>
            </div>
          <% end %>

          <div class="audience-card__actions">
            <%= link_to "View", audience_path(audience),
                class: "btn btn--xs btn-secondary flex-1",
                onclick: "event.stopPropagation()" %>
            <%= link_to "Edit", edit_audience_path(audience),
                class: "btn btn--xs btn-secondary flex-1",
                onclick: "event.stopPropagation()" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="card mt-24">
    <div class="text-center p-16">
      <span class="text-secondary text-sm">
        Showing <%= @audiences.count %> <%= 'audience'.pluralize(@audiences.count) %>
      </span>
    </div>
  </div>
<% else %>
  <div class="card">
    <div class="empty-state">
      <div class="empty-state__icon">ðŸ‘¥</div>
      <h3>No audiences yet</h3>
      <p class="text-secondary">Audiences help you organize and target your communications. Create your first audience to get started.</p>
      <div class="empty-state__actions">
        <%= link_to "Create Your First Audience", new_audience_path, class: "btn btn-primary" %>
      </div>
    </div>
  </div>
<% end %>

<!-- Info Cards -->
<div class="info-card-row">
  <div class="card">
    <div class="info-card__content">
      <div class="info-card__icon">ðŸ“‹</div>
      <div>
        <h4 class="info-card__title">Static Audiences</h4>
        <p class="info-card__text">Manually curated lists of recipients. Perfect for specific teams or departments.</p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="info-card__content">
      <div class="info-card__icon">ðŸ”„</div>
      <div>
        <h4 class="info-card__title">Dynamic Audiences</h4>
        <p class="info-card__text">Automatically updated based on criteria. Recipients are calculated when sending.</p>
      </div>
    </div>
  </div>
</div>
