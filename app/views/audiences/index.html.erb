<% content_for :page_title, "Audiences" %>

<div class="page-header">
  <h2 class="page-header__title">Audiences</h2>
  <p class="page-header__description">Manage your recipient groups and distribution lists</p>
  <div class="page-header__actions">
    <%= link_to "Create New Audience", new_audience_path, class: "btn btn-primary" %>
  </div>
</div>

<% if @audiences.any? %>
  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
    <% @audiences.each do |audience| %>
      <div class="card" style="padding: 0; overflow: hidden; transition: all 0.2s; cursor: pointer;" 
           onclick="window.location='<%= audience_path(audience) %>'"
           onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-lg)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
        
        <!-- Card Header with Color Bar -->
        <div style="height: 6px; background: linear-gradient(90deg, var(--primary-blue), var(--primary-blue-light));"></div>
        
        <div style="padding: 24px;">
          <!-- Audience Type Badge -->
          <div style="margin-bottom: 16px;">
            <% if audience.type == 'DynamicAudience' %>
              <span class="badge badge-info" style="font-size: 11px;">ðŸ”„ Dynamic</span>
            <% else %>
              <span class="badge badge-success" style="font-size: 11px;">ðŸ“‹ Static</span>
            <% end %>
          </div>
          
          <!-- Audience Name -->
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--dark-text);">
            <%= audience.name %>
          </h3>
          
          <!-- Description -->
          <% if audience.description.present? %>
            <p style="color: var(--secondary-text); font-size: 14px; margin-bottom: 16px; line-height: 1.5;">
              <%= truncate(audience.description, length: 100) %>
            </p>
          <% else %>
            <p style="color: var(--dark-gray); font-size: 14px; margin-bottom: 16px; font-style: italic;">
              No description provided
            </p>
          <% end %>
          
          <!-- Stats -->
          <div style="display: flex; gap: 16px; padding: 12px 0; border-top: 1px solid var(--light-gray); border-bottom: 1px solid var(--light-gray); margin-bottom: 16px;">
            <div style="flex: 1; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--primary-blue);">
                <% 
                  recipient_count = if audience.respond_to?(:recipients) && audience.recipients.respond_to?(:count)
                    audience.recipients.count
                  elsif audience.respond_to?(:users) && audience.users.respond_to?(:count)
                    audience.users.count
                  elsif audience.respond_to?(:members) && audience.members.respond_to?(:count)
                    audience.members.count
                  elsif audience.respond_to?(:recipient_count)
                    audience.recipient_count
                  else
                    0
                  end
                %>
                <%= recipient_count %>
              </div>
              <div style="font-size: 11px; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px;">
                Recipients
              </div>
            </div>
            
            <div style="flex: 1; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--success-green);">
                <%= audience.announcements.count %>
              </div>
              <div style="font-size: 11px; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px;">
                Announcements
              </div>
            </div>
          </div>
          
          <!-- Dynamic Audience Details -->
          <% if audience.type == 'DynamicAudience' && audience.query.present? %>
            <div style="background: rgba(188, 232, 241, 0.1); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 16px;">
              <div style="font-size: 11px; color: var(--secondary-text); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                Query
              </div>
              <div style="font-size: 13px; color: var(--dark-text); font-family: monospace;">
                <%= truncate(audience.query, length: 50) %>
              </div>
            </div>
          <% end %>
          
          <!-- Actions -->
          <div style="display: flex; gap: 8px;">
            <%= link_to "View", audience_path(audience), 
                class: "btn btn-secondary", 
                style: "flex: 1; justify-content: center; font-size: 13px; padding: 8px;",
                onclick: "event.stopPropagation()" %>
            <%= link_to "Edit", edit_audience_path(audience), 
                class: "btn btn-secondary", 
                style: "flex: 1; justify-content: center; font-size: 13px; padding: 8px;",
                onclick: "event.stopPropagation()" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Summary Card -->
  <div class="card" style="margin-top: 24px;">
    <div style="text-align: center; padding: 16px;">
      <span style="color: var(--secondary-text); font-size: 14px;">
        Showing <%= @audiences.count %> <%= 'audience'.pluralize(@audiences.count) %>
      </span>
    </div>
  </div>
<% else %>
  <div class="card">
    <div style="text-align: center; padding: 64px 24px;">
      <div style="font-size: 64px; margin-bottom: 16px;">ðŸ‘¥</div>
      <h3 style="margin-bottom: 8px; font-size: 20px;">No audiences yet</h3>
      <p style="color: var(--secondary-text); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
        Audiences help you organize and target your communications. Create your first audience to get started.
      </p>
      <%= link_to "Create Your First Audience", new_audience_path, class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<!-- Info Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 24px;">
  <div class="card">
    <div style="display: flex; align-items: start; gap: 16px;">
      <div style="font-size: 32px;">ðŸ“‹</div>
      <div>
        <h4 style="font-weight: 600; margin-bottom: 8px;">Static Audiences</h4>
        <p style="font-size: 13px; color: var(--secondary-text); line-height: 1.5;">
          Manually curated lists of recipients. Perfect for specific teams or departments.
        </p>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div style="display: flex; align-items: start; gap: 16px;">
      <div style="font-size: 32px;">ðŸ”„</div>
      <div>
        <h4 style="font-weight: 600; margin-bottom: 8px;">Dynamic Audiences</h4>
        <p style="font-size: 13px; color: var(--secondary-text); line-height: 1.5;">
          Automatically updated based on criteria. Recipients are calculated when sending.
        </p>
      </div>
    </div>
  </div>
</div>
